rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isAuth() {
      return request.auth != null;
    }

    function isProjectMember(projectId) {
      // Ensure the project document exists before trying to access its data.
      return exists(/databases/$(database)/documents/projects/$(projectId)) &&
             request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberUids;
    }
    
    function isProjectOwner(projectId) {
      return request.auth.uid == get(/databases/$(database)/documents/projects/$(projectId)).data.ownerUid;
    }
    
    // A simplified check for now: any authenticated member of a project can write.
    // We can add more granular role checks later if needed.
    function canWrite(projectId) {
      return isAuth() && isProjectMember(projectId);
    }
    
    // =================================
    // Collection Rules
    // =================================

    // --- User & Settings ---
    match /users/{userId} {
      allow read, update: if isAuth() && request.auth.uid == userId;
      allow create: if isAuth();
    }
    
    match /settings/{docId} {
      allow read: if isAuth();
      // Allow any authenticated user to write to the 'global' settings doc,
      // as this is used for shared settings like currency.
      allow write: if isAuth() && docId == 'global';
    }

    // --- Project Document ---
    match /projects/{projectId} {
      allow read: if isAuth() && isProjectMember(projectId);
      // Any authenticated user can create a project.
      allow create: if isAuth(); 
      // Only project members can update. We can refine this to 'editors' later.
      allow update: if isAuth() && canWrite(projectId); 
      // Only the project owner can delete.
      allow delete: if isAuth() && isProjectOwner(projectId);
    }
    
    // --- Generic Project Sub-Collection Rules ---
    // This rule applies to any document in any collection where the document's
    // 'projectId' field matches the {projectId} wildcard.
    match /{path=**}/projectSubCollections/{docId} {
        allow read, write: if isAuth() && isProjectMember(request.resource.data.projectId);
    }

    function projectSubCollectionRules() {
      return {
        'allow read, create': if isAuth() && isProjectMember(request.resource.data.projectId),
        'allow update, delete': if isAuth() && canWrite(resource.data.projectId)
      }
    }
    
    match /tasks/{docId} { rules projectSubCollectionRules(); }
    match /leads/{docId} { rules projectSubCollectionRules(); }
    match /channels/{docId} { rules projectSubCollectionRules(); }
    match /vendors/{docId} { rules projectSubCollectionRules(); }
    match /categories/{docId} { rules projectSubCollectionRules(); }
    match /services/{docId} { rules projectSubCollectionRules(); }
    match /products/{docId} { rules projectSubCollectionRules(); }
    match /packages/{docId} { rules projectSubCollectionRules(); }
    match /notes/{docId} { rules projectSubCollectionRules(); }
    match /aiPrompts/{docId} { rules projectSubCollectionRules(); }
    match /reports/{docId} { rules projectSubCollectionRules(); }
    match /records/{docId} { rules projectSubCollectionRules(); }
    match /taskTemplates/{docId} { rules projectSubCollectionRules(); }
    match /finances/{docId} { rules projectSubCollectionRules(); }
    match /invoices/{docId} { rules projectSubCollectionRules(); }

    // --- Personal Collections (Wallet, Expenses, Vault) ---
    function userOwnedResourceRules() {
       return {
         'allow read, write, delete': if isAuth() && resource.data.userId == request.auth.uid,
         'allow create': if isAuth() && request.resource.data.userId == request.auth.uid
       }
    }

    match /personalWallets/{docId} { rules userOwnedResourceRules(); }
    match /walletTransactions/{docId} {
      allow read, create: if isAuth() && get(/databases/$(database)/documents/personalWallets/$(request.resource.data.walletId)).data.userId == request.auth.uid;
      allow update, delete: if false; // Transactions should be immutable
    }
    match /personalExpenses/{docId} { rules userOwnedResourceRules(); }
    match /personalExpenseCategories/{docId} { rules userOwnedResourceRules(); }
    match /vaultFolders/{docId} { rules userOwnedResourceRules(); }
    match /vaultItems/{docId} { rules userOwnedResourceRules(); }
  }
}